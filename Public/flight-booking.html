<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Confirm Flight Booking</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <h2 class="logo">
      <img src="logo.jpg" alt="RideBooking Logo" />
    </h2>
    <ul>
      <li><a href="index.html#home">Home</a></li>
      <li><a href="index.html#about">About Us</a></li>
      <li><a href="index.html#help">Help</a></li>
      <li><button class="login-btn" onclick="openLoginModal()">Login</button></li>
    </ul>
  </nav>

  <!-- Flight Booking Details Section -->
  <section class="flight-booking">
    <div class="container">
        <h1>Flight Booking Details</h1>
            <p>Below are the details of your selected flight. Please confirm before proceeding.</p>

        <div id="flight-details" class="flight-card-horizontal">
         <!-- Flight details will be injected here -->
        </div>

        <div class="class-selection-container">
         <h2>Select Travel Class</h2>
         <div class="class-options" id="class-options">
            <!-- JS will inject class cards here -->
         </div>
        </div>

        <!-- Replace inside .button-container -->
        <div class="button-container">
          <button class="black-btn" onclick="showNextPage()">Next</button>
        </div>

        <!-- Add after closing </section> -->
        <div id="next-page" class="slide-page">
          <div class="container">
            <h2>Passenger Details</h2>
            <p>Please fill details as per Government ID. Click each section to expand.</p>
            <form id="passenger-form"></form>
            
            <div class="contact-details">
              <h4>Contact Details</h4>
              <p class="note">Details and updates of the flight will be sent to you on your registered mobile number and email.</p>

              <label for="email">Email ID:</label>
              <input type="email" id="email" name="email" placeholder="you@example.com" required>

              <label for="mobile">Mobile Number:</label>
              <input type="tel" id="mobile" name="mobile" placeholder="10-digit number" pattern="[0-9]{10}" required>
            </div>

            <div class="button-container">
              <button class="black-btn" type="button" onclick="showFinalStep()">Next</button>
            </div>
            <div id="final-step" class="slide-page">
              <div class="container">
                <h2>Select Your Flight Seat</h2>
                <p class="note" style="color: #b00; font-style: italic;">Note: Infants do not get separate seats and must travel in the lap of an adult. To book a separate seat, include them under 'Children' instead.</p>

                <div class="plane-container">
                  <div class="plane">
                    <div class="cockpit">Cockpit ‚úà</div>
                    <div id="seatRows"></div>
                  </div>
                  <div class="tail">Tail of the plane</div>
                </div>

                <div class="info">
                  <p>Class: <strong id="class-name"></strong></p>
                  <p>Selected Seats: <span id="selectedSeats">None</span></p>
                  <button onclick="confirmSeats()">Confirm & Proceed</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <style>
          .slide-page {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100%;
            background: #fff;
            z-index: 1000;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
            transition: right 0.5s ease;
            overflow-y: auto;
            padding: 20px 0;
          }

          .slide-page.show {
            right: 0;
          }
        </style>

        <script>
          function showNextPage() {
            document.getElementById("next-page").classList.add("show");
          }
        </script>
  </section>

<script>
    function loadFlightDetails() {
        const flight = JSON.parse(localStorage.getItem("selectedFlight"));
        if (!flight) {
        document.getElementById("flight-details").innerHTML = "<p>No flight selected.</p>";
        return;
        }

        const depTime = new Date(flight.departureTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const arrTime = new Date(flight.arrivalTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        document.getElementById("flight-details").innerHTML = `
        <div class="left-section">
            <div class="row"><strong>${flight.airline} (${flight.flightNumber})</strong></div>
            <div class="row"><strong>Date:</strong> ${flight.date}</div>
            <div class="row">From: ${flight.from} ‚Üí To: ${flight.to}</div>
            <div class="row">Departure Time: ${depTime}</div>
            <div class="row">Arrival Time: ${arrTime}</div>
            <div class="row">Duration: ${flight.duration}</div>
        </div>
        `;
    }

    function loadClassOptions() {
        const flight = JSON.parse(localStorage.getItem("selectedFlight"));
        if (!flight || !flight.classes) {
        document.getElementById("class-options").innerHTML = "<p style='color: gray;'>No class options available.</p>";
        return;
        }

        const classOptionsDiv = document.getElementById("class-options");
        classOptionsDiv.innerHTML = "";

        for (const [className, details] of Object.entries(flight.classes)) {
        const fare = details.fare;
        const seats = details.availableSeats;
        const baggage = className === "First" ? "25" : className === "Business" ? "20" : "15";
        const seatType = className === "First" ? "Recliner Seat" : className === "Business" ? "Wide Seat" : "Standard Seat";
        const meal = className === "Economy" ? "Paid meal" : "Free meal";

        const card = document.createElement("div");
        card.className = "class-card";
        card.innerHTML = `
            <h3>${className} Class</h3>
            <p class="fare">Fare: ‚Çπ${fare}</p>
            <ul>
            <li>üß≥ 7 kg Cabin + ${baggage} kg Check-in</li>
            <li>üí∫ ${seatType}</li>
            <li>üçΩ ${meal}</li>
            <li>üéü Available Seats: ${seats}</li>
            </ul>
            <button class="select-btn" onclick="selectClass('${className}')">Select</button>
        `;
        classOptionsDiv.appendChild(card);
        }
    }

    function selectClass(className) {
        const flight = JSON.parse(localStorage.getItem("selectedFlight"));
        flight.travelClass = className;
        localStorage.setItem("selectedFlight", JSON.stringify(flight));
        alert(`${className} Class Selected`);
    }

    function renderPassengerForms() {
      const flight = JSON.parse(localStorage.getItem("selectedFlight"));
      if (!flight || !flight.passengers) return;

      const { adults = 0, children = 0, infants = 0, seniors = 0 } = flight.passengers;
      const total = adults + children + infants + seniors;
      const today = new Date().toISOString().split("T")[0];

      const form = document.getElementById("passenger-form");
      form.innerHTML = "";

      let index = 0;

      const createBlock = (type, count, minAge, maxAge) => {
        for (let i = 0; i < count; i++, index++) {
          const id = `passenger-${index}`;
          form.innerHTML += `
            <div class="passenger-block" id="${id}">
              <div class="passenger-header" onclick="togglePassenger('${id}')">
                Passenger ${index + 1} (${type})
                <i class="fas fa-chevron-down"></i>
              </div>
              <div class="passenger-content">
                <div class="input-box">
                  <label>Full Name (as per Government ID):</label>
                  <input type="text" name="name-${index}" required placeholder="First Last">
                </div>
                <div class="input-box">
                  <label>Gender:</label>
                  <select name="gender-${index}" required>
                    <option value="">Select</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="input-box">
                  <label>Date of Birth:</label>
                  <input type="date" name="dob-${index}" max="${today}" required
                    onblur="validateDOB(this, '${type}', ${minAge}, ${maxAge})">
                </div>
              </div>
            </div>
          `;
        }
      };

      createBlock("Adult", adults, 18, 59);
      createBlock("Child", children, 2, 12);
      createBlock("Infant", infants, 0, 1.99);
      createBlock("Senior", seniors, 60, 120);
    }

    function togglePassenger(id) {
      const block = document.getElementById(id);
      block.classList.toggle("active");
    }

    function validateDOB(input, type, minAge, maxAge) {
      const dob = new Date(input.value);
      const today = new Date();
      const age = (today - dob) / (1000 * 60 * 60 * 24 * 365.25);

      if (dob > today) {
        alert("Date of Birth cannot be in the future.");
        input.value = "";
        return;
      }

      if (age < minAge || age > maxAge) {
        alert(`${type} passenger must be between ${minAge} and ${maxAge} years old.`);
        input.value = "";
      }
    }

    function showFinalStep() {
      const form = document.getElementById("passenger-form");
      const email = document.getElementById("email");
      const mobile = document.getElementById("mobile");

      // Check all passenger fields
      const inputs = form.querySelectorAll("input, select");
      for (let input of inputs) {
        if (!input.value.trim()) {
          alert("Please fill all passenger details correctly before proceeding.");
          input.focus();
          return;
        }
      }

      // Validate contact details
      if (!email.value.trim() || !email.checkValidity()) {
        alert("Please enter a valid email address.");
        email.focus();
        return;
      }

      if (!mobile.value.trim() || !mobile.checkValidity()) {
        alert("Please enter a valid 10-digit mobile number.");
        mobile.focus();
        return;
      }

      // If everything is filled, proceed to seat selection
      document.getElementById("final-step").classList.add("show");

      const flight = JSON.parse(localStorage.getItem("selectedFlight"));
      const selectedClass = flight?.travelClass || "Economy";
      document.getElementById("class-name").textContent = selectedClass;

      const availableSeats = flight?.classes?.[selectedClass]?.availableSeats || 0;

      const { adults = 0, children = 0, infants = 0, seniors = 0 } = flight?.passengers || {};
      const totalPassengers = adults + children + seniors;

      const seatConfig = {
        Economy: { seatsPerRow: 6 },
        Business: { seatsPerRow: 4 },
        First: { seatsPerRow: 2 }
      };

      const config = seatConfig[selectedClass] || seatConfig.Economy;
      const seatRowsContainer = document.getElementById("seatRows");
      const selectedSeatsDisplay = document.getElementById("selectedSeats");

      const selectedSeats = [];
      const bookedSeats = [];

      seatRowsContainer.innerHTML = "";
      let seatNumber = 1;
      let seatCount = 0;

      while (seatCount < availableSeats) {
        const row = document.createElement("div");
        row.className = "seat-row";

        const left = document.createElement("div");
        left.className = "seat-block";

        const aisle = document.createElement("div");
        aisle.className = "aisle"; // space between sides

        const right = document.createElement("div");
        right.className = "seat-block";

        let perSide = 3; // Economy
        if (selectedClass === "Business") perSide = 2;
        if (selectedClass === "First") perSide = 1;

        // left side
        for (let j = 0; j < perSide; j++) {
          if (seatCount < availableSeats) {
            const seatLeft = createSeatElement(`${seatNumber}${String.fromCharCode(65 + j)}`);
            left.appendChild(seatLeft);
            seatCount++;
          } else {
            left.appendChild(createEmptySeat());
          }
        }

        // right side
        for (let j = 0; j < perSide; j++) {
          if (seatCount < availableSeats) {
            const seatRight = createSeatElement(`${seatNumber}${String.fromCharCode(65 + perSide + j)}`);
            right.appendChild(seatRight);
            seatCount++;
          } else {
            right.appendChild(createEmptySeat());
          }
        }

        seatNumber++; // increment row number

        row.appendChild(left);
        row.appendChild(aisle);
        row.appendChild(right);
        seatRowsContainer.appendChild(row);
      }

      function createEmptySeat() {
        const seat = document.createElement("div");
        seat.className = "seat empty";
        return seat;
      }

      function createSeatElement(seatId) {
        const seat = document.createElement("div");
        seat.className = "seat";
        seat.textContent = seatId;

        if (bookedSeats.includes(seatId)) {
          seat.classList.add("booked");
        } else {
          seat.addEventListener("click", () => {
            if (seat.classList.contains("selected")) {
              seat.classList.remove("selected");
              selectedSeats.splice(selectedSeats.indexOf(seatId), 1);
            } else {
              if (selectedSeats.length >= totalPassengers) {
                alert(`You can only select ${totalPassengers} seat(s) for the number of passengers.`);
                return;
              }

              seat.classList.add("selected");
              selectedSeats.push(seatId);
            }

            selectedSeatsDisplay.textContent = selectedSeats.length
              ? selectedSeats.join(", ")
              : "None";
          });
        }

        return seat;
      }

      window.confirmSeats = function () {
        if (selectedSeats.length < totalPassengers) {
          alert(`Please select ${totalPassengers} seat(s) to proceed.`);
          return;
        }

        localStorage.setItem("selectedSeats", JSON.stringify(selectedSeats));
        alert("Seats confirmed! Proceeding to payment.");
        window.location.href = "flight-payment.html";
      };

      // Save all passenger details to localStorage
      const passengerDetails = [];

      for (let i = 0; i < form.children.length; i++) {
        const block = form.children[i];
        const inputs = block.querySelectorAll("input, select");
        if (inputs.length === 3) {
          const name = inputs[0].value.trim();
          const gender = inputs[1].value;
          const dob = inputs[2].value;
          passengerDetails.push({ name, gender, dob });
        }
      }

      localStorage.setItem("flightPassengerDetails", JSON.stringify(passengerDetails));
      localStorage.setItem('flightPassengerDetails', JSON.stringify(passengerDetailsArray));
      localStorage.setItem("phoneNumber", mobile.value);
      localStorage.setItem("email", email.value);
    }

    window.onload = function () {
      loadFlightDetails();
      loadClassOptions();
      renderPassengerForms();
    };
</script>
</body>
</html>
